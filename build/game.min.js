class JA{constructor(e,t){let s=this;s.sp=null,s.aN="";var c=void 0;s.setConfig=e=>{c={fr:0,fc:e.c,tk:0,tif:e.d,fs:e.s}},s.ss=async e=>{s.sp=await l(e),s.aN=e},s.ss(e),ie(t)||s.setConfig(t),s.up=()=>{if(ie(c))throw Error("No config");return c.tk>c.tif&&(c.tk=0,c.fr++,c.fr>=c.fc&&(c.fr=0)),c.tk++,{dx:c.fr*c.fs,dy:0,sx:c.fs,sy:c.fs}}}}class JE{constructor(e,t){let s=this;s.n=e,s.g=ie(t)?"object":t,s.pt=1;var c,i=!1,r=!1,p=[];s.t={x:0,y:0,w:20,h:20},s.color="#fff",s.sp=null,s.uv=void 0,s.st=()=>{},s.up=()=>{},s.r=()=>{var{x:e,y:t,w:p,h:l}=s.t;if(e+=wm.x,t+=wm.y,i||r)if(ie(s.uv)&&!r)c2d.drawImage(s.sp,e,t,p,l);else{let{dx:i,dy:n,sx:a,sy:o}=r?c.up():s.uv,y=r?c.sp:s.sp;c2d.drawImage(y,i,n,a,o,e,t,p,l)}else c2d.beginPath(),c2d.rect(e,t,p,l),c2d.fillStyle=s.color,c2d.fill()},s.ss=async(e,t)=>{ie(t)||(s.uv=t),s.sp=await l(e),i=!0,r=!1},s.sa=e=>p=e,s.pa=e=>{let t=p.find(t=>t.aN==e);ie(t)||(c=t,r=!0)},s.oc=e=>{}}}SW=window.innerWidth-10,SH=window.innerHeight,wm={x:0,y:0},els=[],c2d=null,l=e=>new Promise(t=>{var s=new Image;s.src=`assets/${e}.png`,s.onload=()=>{t(s)}}),ie=e=>null==e,kp=[],ip=e=>!ie(kp.find(t=>t.key==e)),dj=e=>{},ic=(e,t)=>{let s=e.t,c=t.t,i=s.x,r=s.y,p=s.x+s.w,l=s.y+s.h,n=c.x,a=c.y,o=c.x+c.w,y=c.y+c.h;return!(l<a||r>y||p<n||i>o)},fc=(e,t)=>{if(ie(t))return py.cs.findIndex(t=>t.c1==e||t.c2==e);{let s=py.cs.findIndex(s=>s.c1==e&&s.c2==t);return-1!=s?s:void 0}},py={cs:[],adc:(e,t)=>{ie(fc(e,t))&&py.cs.push({c1:e,c2:t})},rc:(e,t)=>{let s=fc(e,t);ie(s)||py.cs.splice(s,1)},rcf:e=>{let t=fc(e);for(;-1!=t;)py.cs.splice(t,1),t=fc(e)},pycc:(e,t)=>{let s=py.sv(e,t);1==s?(e.oc(t),t.oc(e)):0==s&&py.rc(e,t)},apply:e=>{-1==fc(e)&&0!==e.pt&&(e.t.y+=10)},sv:(e,t)=>{if(ie(e)||ie(t)||e==t)return-1;if(!ic(e,t))return 0;let s=e.t,c=t.t,i=s.w/2+s.x,r=s.h/2+s.y,p=c.w/2+c.x,l=c.h/2+c.y,n=(p-i)/(c.w/2),a=(l-r)/(c.h/2),o=Math.abs(n),y=Math.abs(a);return Math.abs(o-y)<.1||o>y?(s.x=n<0?c.x+c.w:c.x-s.w,a<0&&s.y>l?s.y=c.y+c.h:s.y+s.h-c.y<5&&(s.y=c.y-s.h)):s.y=a<0?c.y+c.h:c.y-s.h,py.adc(e,t),1}};class Coin{constructor(e,t){let s=this;var c=[new JA("coin",{c:8,s:32,d:5})];s.e=new JE("coin"),s.e.sa(c),s.e.t={x:e,y:t,w:45,h:45},s.e.up=()=>{s.e.pa("coin")}}}class Player{constructor(){let e=this;e.e=new JE("p"),e.e.g="p",e.e.pt=1;var t=e.e.t={x:105,y:SH-300,w:25,h:50},s=!1,c=20;e.e.st=()=>{e.e.ss("dude")},e.e.up=()=>{ip("d")?(t.x+=5,t.x>SW/2&&(wm.x=-t.x+SW/2)):ip("a")&&(t.x-=5,t.x>SW/2&&(wm.x=-t.x+SW/2)),!s&&ip("space")?(s=!0,t.y-=5):s&&(e.e.pt=0,t.y-=c,--c<-20&&(c=-20)),t.y>SH&&(t.y=SH-400)},e.e.oc=t=>{"coin"==t.n&&dj(t),"tile"==t.g&&(s=!1,c=20,e.e.pt=1)}}}class TileMap{constructor(){let e=this;var t="tileTest",s=[],c=8;e.t={x:0,y:0,w:8,h:8},e.sp=null,e.ctm=i=>{if(ie(i))throw Error("No Tile Settings given");if(ie(i.t)||(e.t=i.t),ie(i.tss)||(c=i.tss),ie(i.tsp)||(t=i.tsp),e.ss(t),!ie(i.tm)){let r=i.tm,p=-1;r.forEach(e=>{if(-1==p&&(p=e.length),p!=e.length)throw Error("Tile map is misshapen")});let{x:l,y:n,w:a,h:o}=e.t;r.forEach(i=>{i.forEach(e=>{if(0!=e){let i=(e-1)*c,r=new JE(`tile${l}x${n}|${e}`,"tile");r.t={x:l,y:n,w:a,h:o},r.uv={dx:i,dy:0,sx:8,sy:8},r.ss(t),s.push(r)}l+=a}),n+=o,l=e.t.x})}},e.r=()=>{ie(s)||ie(e.sp)||s.forEach(e=>e.r())},e.spy=()=>{null!==s&&els.forEach(e=>{s.forEach(t=>py.pycc(e,t))})},e.ss=async s=>{e.sp=await l(s),t=s}}}var lop=!1,cv=document.getElementById("cv");cv.setAttribute("width",SW),cv.setAttribute("height",SH);var ctx=cv.getContext("2d");ctx.imageSmoothingEnabled=!1,c2d=ctx;var tm=new TileMap,p=new Player;els=[new Coin(495,SH-800).e,new Coin(600,SH-300).e,p.e],tm.ctm({t:{x:50,y:SH-400,w:50,h:50},tss:8,tm:[[1,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[3,3,3,3,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]}),st=()=>{els.forEach(e=>e.st()),lop=!0,up()},up=()=>{els.forEach(e=>{e.up(),py.pycc(p.e,e)}),tm.spy(),els.forEach(e=>py.apply(e)),ctx.clearRect(0,0,SW,SH),tm.r(),els.forEach(e=>e.r()),lop?window.requestAnimationFrame(up):alert("bye!")},inputDown=e=>{let t=e.which||e.keyCode,s=32==t?"space":e.key;ip(s)||kp.push({code:t,key:s}),27==t&&(lop=!1)},inputUp=e=>{let t=e.which||e.keyCode,s=kp.findIndex(e=>e.code==t);kp.splice(s,1)},dj=e=>{let t=els.indexOf(e);-1!=t&&(els.splice(t,1),py.rcf(e))},st();