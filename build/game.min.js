class JA{constructor(e,t){let s=this;s.sp=null,s.aN="";var i=void 0;s.setConfig=e=>{i={fr:0,fc:e.c,tk:0,tif:e.d,fs:e.s}},s.ss=async e=>{s.sp=await l(e),s.aN=e},s.ss(e),ie(t)||s.setConfig(t),s.up=()=>{if(ie(i))throw Error("No config");return i.tk>i.tif&&(i.tk=0,i.fr+=rewind?1:-1,i.fr>=i.fc&&(i.fr=0),i.fr<0&&(i.fr=i.fc-1)),i.tk++,{dx:i.fr*i.fs,dy:0,sx:i.fs,sy:i.fs}}}}class JE{constructor(e,t){let s=this;s.n=e,s.g=ie(t)?"object":t,s.pt=1,s.rewindLogic=1;var i,c=!1,r=!1,p=[];s.t={x:0,y:0,w:20,h:20},s.color="#fff",s.sp=null;var a=[];s.uv=void 0,s.st=()=>{},s.up=()=>{},s.callUpdate=()=>{var{x:e,y:t}=s.t;if(1==s.rewindLogic&&(rewind||a.push({x:e,y:t}),a.length>=150&&a.shift(),rewind&&a.length>0)){let e=a.pop();s.t.x=e.x,s.t.y=e.y}s.up()},s.r=()=>{var{x:e,y:t,w:l,h:p}=s.t;if(e=(e+wm.x)*asp,t=(t+wm.y)*asp,l*=asp,p*=asp,c||r)if(ie(s.uv)&&!r)c2d.drawImage(s.sp,e,t,l,p);else{let{dx:c,dy:a,sx:n,sy:o}=r?i.up():s.uv,y=r?i.sp:s.sp;c2d.drawImage(y,c,a,n,o,e,t,l,p)}else c2d.beginPath(),c2d.rect(e,t,l,p),c2d.fillStyle=s.color,c2d.fill()},s.ss=async(e,t)=>{ie(t)||(s.uv=t),s.sp=await l(e),c=!0,r=!1},s.sa=e=>p=e,s.pa=e=>{let t=p.find(t=>t.aN==e);ie(t)||(i=t,r=!0)},s.oc=e=>{}}}const SW=window.innerWidth-10,SH=window.innerHeight,asp=(SW+SH)/3e3*1.3,wm={x:0,y:0};var rewind=!1;els=[],c2d=null;const l=e=>new Promise(t=>{var s=new Image;s.src=`assets/${e}.png`,s.onload=()=>{t(s)}}),ie=e=>null==e;kp=[];const ip=e=>!ie(kp.find(t=>t.key==e));dj=e=>{},gameOver=()=>{},ic=(e,t)=>{let s=e.t,i=t.t,c=s.x,r=s.y,l=s.x+s.w,p=s.y+s.h,a=i.x,n=i.y,o=i.x+i.w,y=i.y+i.h;return!(p<n||r>y||l<a||c>o)},fc=(e,t)=>{if(ie(t))return py.cs.findIndex(t=>t.c1==e||t.c2==e);{let s=py.cs.findIndex(s=>s.c1==e&&s.c2==t);return-1!=s?s:void 0}},py={cs:[],adc:(e,t)=>{ie(fc(e,t))&&py.cs.push({c1:e,c2:t})},rc:(e,t)=>{let s=fc(e,t);ie(s)||py.cs.splice(s,1)},rcf:e=>{let t=fc(e);for(;-1!=t;)py.cs.splice(t,1),t=fc(e)},pycc:(e,t)=>{let s=py.sv(e,t);1==s?(e.oc(t),t.oc(e)):0==s&&py.rc(e,t)},apply:e=>{-1==fc(e)&&0!==e.pt&&(e.t.y+=10)},sv:(e,t)=>{if(ie(e)||ie(t)||e==t)return-1;if(!ic(e,t))return 0;let s=e.t,i=t.t,c=s.w/2+s.x,r=s.h/2+s.y,l=i.w/2+i.x,p=i.h/2+i.y,a=(l-c)/(i.w/2),n=(p-r)/(i.h/2),o=Math.abs(a),y=Math.abs(n);return Math.abs(o-y)<.1||o>y?(s.x=a<0?i.x+i.w:i.x-s.w,n<0&&s.y>p?s.y=i.y+i.h:s.y+s.h-i.y<5&&(s.y=i.y-s.h)):s.y=n<0?i.y+i.h:i.y-s.h,py.adc(e,t),1}};class Coin{constructor(e,t,s){let i=this;var c=[new JA("coin",{c:8,s:32,d:5})];i.e=new JE("coin"),i.e.sa(c),i.e.pt=s?1:0,i.e.t={x:e,y:t,w:45,h:45},i.e.up=()=>{i.e.pa("coin")}}}class Player{constructor(){let e=this;e.e=new JE("p"),e.e.g="p",e.e.pt=1;var t=e.e.t={x:105,y:SH-300,w:25,h:50},s=!1,i=20;e.e.st=()=>{e.e.ss("dude")},e.e.up=()=>{rewind=ip("e"),ip("d")?t.x+=5:ip("a")&&(t.x-=5),t.x>SW/2&&(wm.x=-t.x+SW/2),!s&&ip("space")?(s=!0,t.y-=5):s&&(e.e.pt=0,t.y-=i,--i<-20&&(i=-20)),t.y*asp>SH&&gameOver()},e.e.oc=t=>{"coin"==t.n&&dj(t),"tile"==t.g&&(s=!1,i=20,e.e.pt=1)}}}class TileMap{constructor(){let e=this;var t="tileTest",s=[],i=8;e.t={x:0,y:0,w:8,h:8},e.sp=null,e.ctm=c=>{if(ie(c))throw Error("No Tile Settings given");if(ie(c.t)||(e.t=c.t),ie(c.tss)||(i=c.tss),ie(c.tsp)||(t=c.tsp),e.ss(t),!ie(c.tm)){let r=c.tm,l=-1;r.forEach(e=>{if(-1==l&&(l=e.length),l!=e.length)throw Error("Tile map is misshapen")});let{x:p,y:a,w:n,h:o}=e.t;r.forEach(c=>{c.forEach(e=>{if(0!=e){let c=(e-1)*i,r=new JE(`tile${p}x${a}|${e}`,"tile");r.t={x:p,y:a,w:n,h:o},r.uv={dx:c,dy:0,sx:8,sy:8},r.ss(t),r.rewindLogic=0,s.push(r)}p+=n}),a+=o,p=e.t.x})}},e.r=()=>{ie(s)||ie(e.sp)||s.forEach(e=>e.r())},e.spy=()=>{null!==s&&els.forEach(e=>{s.forEach(t=>py.pycc(e,t))})},e.ss=async s=>{e.sp=await l(s),t=s}}}var lop=!1,cv=document.getElementById("cv");cv.setAttribute("width",SW),cv.setAttribute("height",SH);var ctx=cv.getContext("2d");ctx.imageSmoothingEnabled=!1,c2d=ctx,coins=[[495,SH-150,1],[300,20,1],[500,SH-150,1],[900,SH-150,1],[1200,SH-150,1],[600,360,0],[660,360,0],[730,360,0],[1755,650,1],[1880,650,1],[2210,550,1],[2365,450,1],[2515,550,1]];var tm=new TileMap;els=[(new Player).e],coins.forEach(e=>els.push(new Coin(e[0],e[1],e[2]).e)),tm.ctm({t:{x:50,y:SH-450,w:50,h:50},tss:8,tm:[[1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,1,1,1,0,0,0,1,1,1,0,0,0,1,0,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0],[3,3,3,3,0,0,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1]]}),st=()=>{els.forEach(e=>e.st()),lop=!0,up()},up=()=>{rewind||els.forEach(e=>py.apply(e)),els.forEach(e=>{e.callUpdate(),py.pycc(els[0],e)}),tm.spy(),ctx.clearRect(0,0,SW,SH),tm.r(),els.forEach(e=>e.r()),lop&&window.requestAnimationFrame(up)},inputDown=e=>{let t=e.which||e.keyCode,s=32==t?"space":e.key;ip(s)||kp.push({code:t,key:s}),27==t&&(lop=!1)},inputUp=e=>{let t=e.which||e.keyCode,s=kp.findIndex(e=>e.code==t);kp.splice(s,1)},dj=e=>{let t=els.indexOf(e);-1!=t&&(els.splice(t,1),py.rcf(e))},gameOver=()=>{lop=!1,alert("You lose"),alert("The game will rest now"),window.location.reload()},st();