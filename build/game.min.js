class JA{constructor(a,b){let c=this;c.sp=null,c.aN="";var d;c.setConfig=a=>{d={fr:0,fc:a.c,tk:0,tif:a.d,fs:a.s}},c.ss=async a=>{c.sp=await l(a),c.aN=a},c.ss(a),ie(b)||c.setConfig(b),c.up=()=>{if(ie(d))throw Error("No config");return d.tk>d.tif&&(d.tk=0,d.fr++,d.fr>=d.fc&&(d.fr=0)),d.tk++,{dx:d.fr*d.fs,dy:0,sx:d.fs,sy:d.fs}}}}class JE{constructor(a,b){let c=this;c.n=a,c.g=ie(b)?"object":b,c.pt=1;var d,e=!1,f=!1,g=[];c.t={x:0,y:0,w:20,h:20},c.color="#fff",c.sp=null,c.uv=void 0,c.st=()=>{},c.up=()=>{},c.r=()=>{var{x:a,y:b,w:g,h:i}=c.t;if(a+=wm.x,b+=wm.y,!e&&!f)c2d.beginPath(),c2d.rect(a,b,g,i),c2d.fillStyle=c.color,c2d.fill();else if(ie(c.uv)&&!f)c2d.drawImage(c.sp,a,b,g,i);else{let{dx:e,dy:h,sx:j,sy:k}=f?d.up():c.uv,m=f?d.sp:c.sp;c2d.drawImage(m,e,h,j,k,a,b,g,i)}},c.ss=async(a,b)=>{ie(b)||(c.uv=b),c.sp=await l(a),e=!0,f=!1},c.sa=a=>g=a,c.pa=a=>{let b=g.find(b=>b.aN==a);ie(b)||(d=b,f=!0)},c.oc=()=>{}}}SW=window.innerWidth-10,SH=window.innerHeight,wm={x:0,y:0},els=[],c2d=null,l=a=>new Promise(b=>{var c=new Image;c.src=`assets/${a}.png`,c.onload=()=>{b(c)}}),ie=a=>a===void 0||null===a,kp=[],ip=a=>!ie(kp.find(b=>b.key==a)),dj=()=>{},ic=(a,b)=>{let c=a.t,d=b.t,e=c.x,f=c.y,g=c.x+c.w,h=c.y+c.h,i=d.x,j=d.y,k=d.x+d.w,m=d.y+d.h;return!(h<j||f>m||g<i||e>k)},fc=(a,b)=>{if(!ie(b)){let c=py.cs.findIndex(c=>c.c1==a&&c.c2==b);return-1==c?void 0:c}return py.cs.findIndex(b=>b.c1==a||b.c2==a)},py={cs:[],adc:(a,b)=>{ie(fc(a,b))&&py.cs.push({c1:a,c2:b})},rc:(a,b)=>{let c=fc(a,b);ie(c)||py.cs.splice(c,1)},rcf:a=>{for(let b=fc(a);-1!=b;)py.cs.splice(b,1),b=fc(a)},pycc:(a,b)=>{let c=py.sv(a,b);1==c?(a.oc(b),b.oc(a)):0==c&&py.rc(a,b)},apply:a=>{let b=fc(a);-1==b&&0!==a.pt&&(a.t.y+=10)},sv:(a,b)=>{if(ie(a)||ie(b)||a==b)return-1;if(!ic(a,b))return 0;let c=a.t,d=b.t,e={x:c.w/2+c.x,y:c.h/2+c.y},f={x:d.w/2+d.x,y:d.h/2+d.y},g=(f.x-e.x)/(d.w/2),h=(f.y-e.y)/(d.h/2),i=Math.abs(g),j=Math.abs(h);return .1>Math.abs(i-j)||i>j?(c.x=0>g?d.x+d.w:d.x-c.w,0>h&&c.y>f.y?c.y=d.y+d.h:5>c.y+c.h-d.y&&(c.y=d.y-c.h)):0>h?c.y=d.y+d.h:c.y=d.y-c.h,py.adc(a,b),1}};class Coin{constructor(a,b){let c=this;var d=[new JA("coin",{c:8,s:32,d:5})];c.e=new JE("coin"),c.e.sa(d),c.e.t={x:a,y:b,w:45,h:45},c.e.up=()=>{c.e.pa("coin")}}}class Player{constructor(){let a=this;a.e=new JE("p"),a.e.g="p",a.e.pt=1;var b=a.e.t={x:105,y:SH-300,w:25,h:50},c=!1,d=20;a.e.st=()=>{a.e.ss("dude")},a.e.up=()=>{ip("d")?(b.x+=5,b.x>SW/2&&(wm.x=-b.x+SW/2)):ip("a")&&(b.x-=5,b.x>SW/2&&(wm.x=-b.x+SW/2)),!c&&ip("space")?(c=!0,b.y-=5):c&&(a.e.pt=0,b.y-=d,d--,-20>d&&(d=-20)),b.y>SH&&(b.y=SH-400)},a.e.oc=b=>{"coin"==b.n&&dj(b),"tile"==b.g&&(c=!1,d=20,a.e.pt=1)}}}class TileMap{constructor(){let a=this;var b="tileTest",c=[],d=8;a.t={x:0,y:0,w:8,h:8},a.sp=null,a.ctm=e=>{if(ie(e))throw Error("No Tile Settings given");if(ie(e.t)||(a.t=e.t),ie(e.tss)||(d=e.tss),ie(e.tsp)||(b=e.tsp),a.ss(b),!ie(e.tm)){let f=e.tm,g=-1;f.forEach(a=>{if(-1==g&&(g=a.length),g!=a.length)throw Error("Tile map is misshapen")});let{x:i,y:j,w:k,h:m}=a.t;f.forEach(e=>{e.forEach(a=>{if(0!=a){let f=(a-1)*d,g=new JE(`tile${i}x${j}|${a}`,"tile");g.t={x:i,y:j,w:k,h:m},g.uv={dx:f,dy:0,sx:8,sy:8},g.ss(b),c.push(g)}i+=k}),j+=m,i=a.t.x})}},a.r=()=>{ie(c)||ie(a.sp)||c.forEach(a=>a.r())},a.spy=()=>{null===c||els.forEach(a=>{c.forEach(b=>py.pycc(a,b))})},a.ss=async c=>{a.sp=await l(c),b=c}}}var lop=!1,cv=document.getElementById("cv");cv.setAttribute("width",SW),cv.setAttribute("height",SH);var ctx=cv.getContext("2d");ctx.imageSmoothingEnabled=!1,c2d=ctx;var tm=new TileMap,p=new Player;els=[new Coin(495,SH-800).e,new Coin(600,SH-300).e,p.e],tm.ctm({t:{x:50,y:SH-400,w:50,h:50},tss:8,tm:[[1,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[3,3,3,3,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]}),st=()=>{els.forEach(a=>a.st()),lop=!0,up()},up=()=>{els.forEach(a=>{a.up(),py.pycc(p.e,a)}),tm.spy(),els.forEach(a=>py.apply(a)),ctx.clearRect(0,0,SW,SH),tm.r(),els.forEach(a=>a.r()),lop?window.requestAnimationFrame(up):alert("bye!")},inputDown=a=>{let b=a.which||a.keyCode,c=32==b?"space":a.key;ip(c)||kp.push({code:b,key:c}),27==b&&(lop=!1)},inputUp=a=>{let b=a.which||a.keyCode,c=kp.findIndex(a=>a.code==b);kp.splice(c,1)},dj=a=>{let b=els.indexOf(a);-1!=b&&(els.splice(b,1),py.rcf(a))},st();